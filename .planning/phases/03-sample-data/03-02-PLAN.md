---
phase: 03-sample-data
type: execute
---

<objective>
Checkbox + Prefill-Logik beim Erstellen von Uebungsfirmen.

Purpose: Neue Konten optional mit Beispieltransaktionen vorbefuellen
Output: Checkbox in Users/add, Prefill-Methode in Controller
</objective>

<context>
@.planning/BRIEF.md
@.planning/ROADMAP.md
@.planning/phases/03-sample-data/03-01-PLAN.md
@src/Controller/UsersController.php
@src/Template/Users/add.ctp
@config/Seeds/system_accounts.php
@config/Seeds/transaction_pool.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Checkbox in Users/add.ctp</name>
  <files>src/Template/Users/add.ctp</files>
  <action>
  Nach dem Account-Name-Feld, vor dem Submit-Button:

  <div class="mb-3">
      <div class="form-check">
          <?= $this->Form->checkbox('prefill_sample_data', [
              'class' => 'form-check-input',
              'id' => 'prefillSampleData'
          ]) ?>
          <label class="form-check-label" for="prefillSampleData">
              <i class="bi bi-shuffle me-1"></i>
              Mit Beispieltransaktionen vorbefuellen
          </label>
          <div class="form-text">
              Erstellt ~20 zufaellige Transaktionen der letzten 3 Monate
          </div>
      </div>
  </div>

  Checkbox ist standardmaessig NICHT aktiviert.
  </action>
  <verify>Checkbox erscheint im Formular</verify>
  <done>Checkbox mit Label und Hilfetext vorhanden</done>
</task>

<task type="auto">
  <name>Task 2: Prefill-Methode in UsersController</name>
  <files>src/Controller/UsersController.php</files>
  <action>
  Neue private Methode:

  private function _prefillAccountWithSampleData($accountId)
  {
      # System-Konten und Pool laden
      $systemAccounts = include(CONFIG . 'Seeds/system_accounts.php');
      $transactionPool = include(CONFIG . 'Seeds/transaction_pool.php');

      $this->loadModel('Transactions');

      # 20 zufaellige Transaktionen generieren
      $numTransactions = 20;

      for ($i = 0; $i < $numTransactions; $i++) {
          # Zufaelliges Template waehlen
          $template = $transactionPool[array_rand($transactionPool)];
          $partner = $systemAccounts[array_rand($systemAccounts)];

          # Zufaelliger Betrag im Bereich
          $betrag = rand($template['min'] * 100, $template['max'] * 100) / 100;

          # Zufaelliges Datum in letzten 90 Tagen
          $daysAgo = rand(0, 90);
          $datum = new \DateTime("-{$daysAgo} days");

          # Verwendungszweck formatieren
          $verwendung = sprintf($template['text'], rand(1000, 9999), date('Y'));

          $transaction = $this->Transactions->newEntity([
              'account_id' => $accountId,
              'empfaenger_name' => $partner['name'],
              'empfaenger_iban' => $partner['iban'],
              'betrag' => $betrag,
              'verwendungszweck' => $verwendung,
              'datum' => $datum,
              'status' => 'completed',
              # Weitere Felder nach Bedarf
          ]);

          $this->Transactions->save($transaction);
      }

      # Kontostand aktualisieren basierend auf Transaktionen
      $this->_updateAccountBalance($accountId);
  }
  </action>
  <verify>Methode existiert und ist aufrufbar</verify>
  <done>_prefillAccountWithSampleData generiert 20 Transaktionen</done>
</task>

<task type="auto">
  <name>Task 3: Prefill in add()-Methode aufrufen</name>
  <files>src/Controller/UsersController.php</files>
  <action>
  In add()-Methode, NACH erfolgreicher Konto-Erstellung:

  if ($this->Accounts->save($account)) {
      # Checkbox pruefen
      if ($this->request->getData('prefill_sample_data')) {
          $this->_prefillAccountWithSampleData($account->id);
      }
      $this->Flash->success(__('Uebungsfirma und Konto wurden erstellt.'));
  }

  WICHTIG: Nur aufrufen wenn Checkbox aktiviert UND Konto erfolgreich erstellt.
  </action>
  <verify>Prefill wird bei aktivierter Checkbox aufgerufen</verify>
  <done>Checkbox-Wert steuert Prefill-Aufruf</done>
</task>

<task type="auto">
  <name>Task 4: Balance-Update-Methode</name>
  <files>src/Controller/UsersController.php</files>
  <action>
  Hilfsmethode zum Aktualisieren des Kontostands:

  private function _updateAccountBalance($accountId)
  {
      $this->loadModel('Accounts');
      $account = $this->Accounts->get($accountId, [
          'contain' => ['Transactions']
      ]);

      # Einnahmen und Ausgaben berechnen
      $balance = 10000; # Startguthaben
      foreach ($account->transactions as $t) {
          if ($t->account_id == $accountId) {
              # Ausgehende Transaktion
              $balance -= $t->betrag;
          } else {
              # Eingehende Transaktion (falls so modelliert)
              $balance += $t->betrag;
          }
      }

      $account->balance = $balance;
      $this->Accounts->save($account);
  }

  HINWEIS: Logik haengt von Transaktions-Modell ab.
  Evtl. anpassen je nach In/Out-Markierung.
  </action>
  <verify>Methode existiert</verify>
  <done>Kontostand wird nach Prefill aktualisiert</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] Checkbox in add.ctp sichtbar
- [ ] _prefillAccountWithSampleData() generiert Transaktionen
- [ ] Kontostand wird korrekt berechnet
- [ ] php -l fuer alle Dateien
- [ ] Manueller Test: Neue Uebungsfirma mit Checkbox erstellen
</verification>

<success_criteria>
- Checkbox funktioniert
- 20 realistische Transaktionen werden erstellt
- Kontostand bleibt positiv (Startguthaben beruecksichtigt)
- Datumswerte verteilt ueber 3 Monate
</success_criteria>

<output>
Nach Abschluss: `.planning/phases/03-sample-data/03-02-SUMMARY.md` erstellen
</output>
